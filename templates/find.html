<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEyZ-WHNVSvtv5X9eDo353TOlSpucMh0k&v=3.exp&sensor=true"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script type="text/javascript">
    {% if last_seen is not none %}
      var map;
      function initialize() {
        var mapOptions = {
          zoom: 8,
          center: new google.maps.LatLng({{ last_seen.lat }}, {{ last_seen.lon }}),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = new google.maps.LatLng({{ last_seen.lat }}, {{ last_seen.lon }});

            $("#LAT").val(position.coords.latitude);
            $("#LON").val(position.coords.longitude);

            map.setCenter(pos);
          }, function() {
            $("#LAT").val('NaN');
            $("#LON").val('NaN');
            handleNoGeolocation(true);
          });
        } else {
          // Browser doesn't support Geolocation
          $("#LAT").val('NaN');
          $("#LON").val('NaN');
          handleNoGeolocation(false);
        }
      }

      function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
          var content = 'Error: The Geolocation service failed.';
        } else {
          var content = 'Error: Your browser doesn\'t support geolocation.';
        }

        var options = {
          map: map,
          position: new google.maps.LatLng({{ last_seen.lat }}, {{ last_seen.lon }}),
          content: content
        };

        map.setCenter(options.position);
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    {% else %}
      var map;
      function initialize() {
        var mapOptions = {
          zoom: 8,
          center: new google.maps.LatLng(55.45, 37.37),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    {% endif %}
    </script>
    
    <TITLE>Twiddler</TITLE>
    <link href="/bootstrap/css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }
    </style>

</head>
<body style="background-image:url(/back.jpg)">
<script src="/bootstrap/js/bootstrap.min.js"></script>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="brand" href="/">Twiddler</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    <li class="divider-vertical"></li>
                    <li><a href="/user/{{ user._id }}">Профиль</a></li>
                    <li class="divider-vertical"></li>
                    <li><a href="/plan/{{ user._id }}">Спланировать</a></li>
                    <li class="divider-vertical"></li>
                    <li><a href="/logout">Выйти</a></li>
                </ul>
                <form method="POST" class="navbar-form pull-right" action="/search">
                    <input type="text" class="span2" placeholder="Search">
                    <!-- button type="submit" class="btn">Найти</button -->
                </form>
            </div><!--/.nav-collapse -->
        </div>
    </div>
</div>

<div class="container">
    <div id="map_canvas" style="width: 550px; height: 450px">
    </div>
    <form method = "POST">
        {% if last_seen is not none %}
            <div>
                <h2><i>Последний раз Вы были:</i></h2>
            </div>
            <div>
                <input size = "11" type = text value = {{ last_seen.lat }} disabled />
                <input size = "11" type = text value = {{ last_seen.lon }} disabled />
            </div>
        {% endif %}
        <div>
            <h2><i>Ваши текущие координаты:</i></h2>
        </div>
        <div id="current_pos" title="Если поле имеет значение NaN - не удалось определить Ваше местоположение. Используйте ручной ввод.">
            <input type = text id = "LAT" size = "11" name = "lat" placeholder = "Введите широту" onclick="set1();" />
            <input type = text id = "LON" size = "11" name = "lon" placeholder = "Введите долготу" onclick="set2();" />
            <script type="text/javascript">
              function set1() {
                if ($('#LAT').val() == "NaN") {
                  $('#LAT').val("");
                }
              }
              function set2() {
                if ($('#LON').val() == "NaN") {
                  $('#LON').val("");
                }
              }
            </script>
        </div>
        <div>
            <button style = "width:210px">Запомнить</button>
        </div>
    </form>
</div>
</body>
</html>